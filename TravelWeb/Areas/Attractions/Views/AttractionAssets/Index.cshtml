@* 告訴網頁，我們要接收的是一組「景點 (Attraction)」的清單 *@
@model IEnumerable<TravelWeb.Areas.Attractions.Models.Attraction>

@{
    ViewData["Title"] = "景點列表";
}

<div class="page-inner">
    <div class="page-header">
        <h4 class="page-title">景點管理</h4>
        <ul class="breadcrumbs">
            <li class="nav-home">
                <a href="#"><i class="flaticon-home"></i></a>
            </li>
            <li class="separator"><i class="flaticon-right-arrow"></i></li>
            <li class="nav-item"><a href="#">景點區</a></li>
        </ul>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex align-items-center">
                        <h4 class="card-title">景點列表</h4>
                        <a asp-area="Attractions" asp-controller="AttractionAssets" asp-action="Create" class="btn btn-primary btn-round ms-auto">
                            <i class="fa fa-plus"></i> 新增景點
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mt-3">
                            <thead class="table-dark">
                                <tr>
                                    <th>編號</th>
                                    <th>區域</th>
                                    <th>景點名稱</th>
                                    <th>地址</th>
                                    <th>電話</th>
                                    <th>狀態</th>
                                    <th style="width: 10%">操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model)
                                {
                                    <tr>
                                        <td>@item.AttractionId</td>
                                        <td><span class="badge badge-info">@item.Region?.RegionName</span></td>
                                        <td><strong>@item.Name</strong></td>
                                        <td>@item.Address</td>
                                        <td>@item.Phone</td>
                                        <td>
                                            @if (item.ApprovalStatus == 1)
                                            {
                                                <button type="button" class="btn btn-xs btn-success"
                                                        onclick="confirmReset(@item.AttractionId, '@item.Name')">
                                                    <i class="fa fa-check"></i> 已核准 (點擊撤回)
                                                </button>
                                            }
                                            else
                                            {
                                                <button type="button" class="btn btn-xs btn-warning"
                                                        onclick="confirmApprove(@item.AttractionId, '@item.Name')">
                                                    <i class="fa fa-clock"></i> 審核中 (點擊通過)
                                                </button>
                                            }
                                            @* 審核專用隱藏表單 *@
                                            <form id="approve-form-@item.AttractionId" asp-action="Approve" asp-route-id="@item.AttractionId" method="post" style="display:none;">
                                                @Html.AntiForgeryToken()
                                            </form>
                                        </td>
                                        <td>
                                            <div class="form-button-action">
                                                @* 查看詳情 *@
                                                <button type="button" class="btn btn-link btn-info btn-lg"
                                                        title="查看詳情" onclick="showDetails(@item.AttractionId)">
                                                    <i class="fa fa-eye"></i>
                                                </button>

                                                @* 編輯：導向 Edit 頁面 *@
                                                <a asp-action="Edit" asp-route-id="@item.AttractionId" class="btn btn-link btn-primary btn-lg" title="編輯">
                                                    <i class="fa fa-edit"></i>
                                                </a>

                                                @* 刪除：觸發 confirmDelete *@
                                                <button type="button" class="btn btn-link btn-danger"
                                                        title="刪除" onclick="confirmDelete(@item.AttractionId, '@item.Name')">
                                                    <i class="fa fa-times"></i>
                                                </button>

                                                @* 刪除專用隱藏表單 *@
                                                <form id="delete-form-@item.AttractionId" asp-action="Delete" asp-route-id="@item.AttractionId" method="post" style="display:none;">
                                                    @Html.AntiForgeryToken()
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@* 查看詳情 Modal *@
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="detailsModalLabel">景點詳細資訊</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="border:none; background:none;">
                    <span aria-hidden="true" style="font-size: 24px;">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="detailsContent">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // --- 審核功能 (核准) ---
        function confirmApprove(id, name) {
            Swal.fire({
                title: '確認核准',
                text: '您確定要通過景點「' + name + '」的審核嗎？',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#31ce36',
                cancelButtonColor: '#d33',
                confirmButtonText: '是的，准許通過！',
                cancelButtonText: '取消'
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById('approve-form-' + id).submit();
                }
            })
        }

        // --- 審核功能 (重設/撤回) ---
        function confirmReset(id, name) {
            Swal.fire({
                title: '重設狀態？',
                text: '您確定要把景點「' + name + '」改回審核中嗎？',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#f39c12',
                cancelButtonColor: '#d33',
                confirmButtonText: '是的，重設它',
                cancelButtonText: '取消'
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById('approve-form-' + id).submit();
                }
            })
        }

        // --- 刪除功能 ---
        function confirmDelete(id, name) {
            Swal.fire({
                title: '確定要刪除嗎？',
                text: '景點「' + name + '」刪除後將無法還原！',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: '是的，刪除它！',
                cancelButtonText: '取消'
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById('delete-form-' + id).submit();
                }
            })
        }

        // --- 查看詳情功能 ---
        function showDetails(id) {
            $('#detailsModal').modal('show');
            $('#detailsContent').html('<div class="text-center"><div class="spinner-border text-primary" role="status"></div></div>');

            $.get('@Url.Action("GetDetails")/' + id, function (data) {
                // 處理圖片區塊
                let imgHtml = '';
                if (data.images && data.images.length > 0) {
                    imgHtml = '<div class="row mt-3">';
                    data.images.forEach(path => {
                        imgHtml += `
                            <div class="col-md-4 mb-3">
                                <a href="${path}" target="_blank">
                                    <img src="${path}" class="img-thumbnail w-100" style="height:150px; object-fit:cover;" title="點擊放大">
                                </a>
                            </div>`;
                    });
                    imgHtml += '</div>';
                } else {
                    imgHtml = '<p class="text-muted">暫無照片</p>';
                }

                let html = `
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>景點名稱：</strong> ${data.name}</p>
                            <p><strong>所屬區域：</strong> ${data.region}</p>
                            <p><strong>地址：</strong> ${data.address}</p>
                            <p><strong>電話：</strong> ${data.phone}</p>
                            <p><strong>新增時間：</strong> ${data.createdAt}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>經度：</strong> ${data.lng}</p>
                            <p><strong>緯度：</strong> ${data.lat}</p>
                            <p><strong>官方網站：</strong> ${data.website !== '無' ? `<a href="${data.website}" target="_blank">點我前往</a>` : '無'}</p>
                        </div>
                        <div class="col-12"><hr></div>
                        <div class="col-12">
                            <p><strong>營業時間：</strong><br>${data.businessHours ? data.businessHours.replace(/\n/g, '<br>') : '無'}</p>
                            <p><strong>公休說明：</strong> ${data.closedDays || '無'}</p>
                            <p><strong>交通資訊：</strong><br>${data.transport || '無'}</p>
                        </div>
                        <div class="col-12"><hr></div>
                        <div class="col-12">
                            <strong>景點照片：</strong>
                            ${imgHtml}
                        </div>
                    </div>
                `;
                $('#detailsContent').html(html);
            }).fail(function() {
                $('#detailsContent').html('<div class="alert alert-danger">讀取資料失敗。</div>');
            });
        }

        // --- 成功提示 ---
        @if (TempData["SuccessMessage"] != null)
        {
                    <text>
                    Swal.fire({
                        icon: 'success',
                        title: '完成！',
                        text: '@Html.Raw(TempData["SuccessMessage"])',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    </text>
        }
    </script>
}

