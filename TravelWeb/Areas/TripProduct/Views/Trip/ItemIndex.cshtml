@model TravelWeb.Areas.TripProduct.Models.ViewModels.ViewModelTripItineraryItems
@{
    ViewData["Title"] = "新增行程細項";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>批次編排行程細項</h2>
        <span class="badge bg-info text-dark">總天數：@Model.MaxDays 天</span>
    </div>
    <p class="text-muted">請依天數分頁填寫。若該時段不選景點，可直接在描述欄位填寫內容（如：自由活動）。</p>

    <form asp-action="BatchCreate" method="post" id="batchForm">
        <input type="hidden" asp-for="TripProductId" />

        <ul class="nav nav-pills mb-4 border p-2 rounded bg-light" id="itineraryTabs" role="tablist">
            @for (int i = 1; i <= Model.MaxDays; i++)
            {
                <li class="nav-item" role="presentation">
                    <button class="nav-link @(i == 1 ? "active" : "")"
                            id="day-tab-@i" data-bs-toggle="tab" data-bs-target="#day-panel-@i"
                            type="button">
                        第 @i 天
                    </button>
                </li>
            }
        </ul>

        <div class="tab-content">
            @for (int i = 1; i <= Model.MaxDays; i++)
            {
                <div class="tab-pane fade @(i == 1 ? "show active" : "")" id="day-panel-@i">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0 text-primary">Day @i 行程安排</h5>
                            <button type="button" class="btn btn-sm btn-primary" onclick="addTimeSlot(@i)">
                                <i class="bi bi-plus-lg"></i> 新增時段
                            </button>
                        </div>
                        <div class="card-body bg-light">
                            <div id="slot-container-@i" class="itinerary-slots">
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        <div class="mt-5 border-top pt-3 text-end">
            <a asp-action="ItemIndex" asp-route-id="@Model.TripProductId" class="btn btn-secondary me-2">取消返回</a>
            <button type="submit" class="btn btn-success btn-lg px-5">全部存檔並提交</button>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        let globalIndex = 0; // 確保 List 索引 [0], [1], [2] 不重複

        function addTimeSlot(day) {
            const container = document.getElementById(`slot-container-${day}`);
            const sortOrder = container.children.length + 1; // 自動計算當天排序

            // 💡 建立樣板，並在 Razor 階段就做好 Null 檢查避免警告
            const template = `
                <div class="card mb-3 border-0 shadow-sm animate__animated animate__fadeIn">
                    <div class="card-body py-3">
                        <div class="row g-2 align-items-end">
                            <input type="hidden" name="[${globalIndex}].DayNumber" value="${day}" />
                            <input type="hidden" name="[${globalIndex}].TripProductId" value="@Model.TripProductId" />

                            <div class="col-md-1">
                                <label class="small text-muted">排序</label>
                                <input name="[${globalIndex}].SortOrder" value="${sortOrder}" class="form-control form-control-sm text-center bg-light" readonly />
                            </div>

                            <div class="col-md-4">
                                <label class="small text-muted">選擇景點 (可不選)</label>
                                <select name="[${globalIndex}].AttractionId" class="form-select form-select-sm">
                                    <option value="">-- 不指定景點 --</option>
                                    @if (Model.AttractionList != null)
                                    {
                                            @foreach (var item in Model.AttractionList)
                                            {
                                                    <option value="@item.Value">@item.Text</option>
                                            }
                                    }
                                </select>
                            </div>

                            <div class="col-md-6">
                                <label class="small text-muted">行程描述</label>
                                <input name="[${globalIndex}].CustomText" class="form-control form-control-sm" placeholder="例如：午餐自理、自由時間" />
                            </div>

                            <div class="col-md-1 text-center">
                                <button type="button" class="btn btn-outline-danger btn-sm border-0" onclick="this.closest('.card').remove()">
                                    ✕
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;

            container.insertAdjacentHTML('beforeend', template);
            globalIndex++;
        }

        // 頁面載入時，自動為每一天生成第一個時段
        window.onload = () => {
            for (let d = 1; d <= @Model.MaxDays; d++) {
                addTimeSlot(d);
            }
        };
    </script>
}